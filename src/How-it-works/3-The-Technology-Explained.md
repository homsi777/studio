# 3. شرح التقنية: كيف يعمل النظام من الداخل؟

هذا المستند مخصص لأولئك الذين يرغبون في فهم أعمق لكيفية بناء نظام "المائدة"، مع التركيز على أهم القرارات التقنية التي تم اتخاذها.

---

## 1. بنية المشروع (Project Structure)

تم تنظيم المشروع بطريقة معيارية لتسهيل الصيانة والتطوير المستقبلي.

*   **`src/app`:** هذا هو قلب تطبيق Next.js. كل مجلد بداخله يمثل "مساراً" أو صفحة في التطبيق (مثل `/chef`, `/settings`).
*   **`src/components`:** يحتوي على جميع مكونات React القابلة لإعادة الاستخدام. تم تقسيمها أيضاً إلى مجلدات فرعية حسب كل قسم (`/dashboard`, `/chef`...) لزيادة التنظيم.
*   **`src/hooks`:** يحتوي على "الخطافات" المخصصة، وهي التي تدير منطق الواجهة الأمامية.
    *   **`use-order-flow.tsx`:** هذا هو أهم خطاف في التطبيق، إنه العقل المدبر الذي يتتبع جميع الطلبات وحالاتها ويزامنها بين جميع الشاشات.
    *   **`use-auth.tsx`:** يدير عملية تسجيل الدخول والخروج.
*   **`src/lib`:** يحتوي على الأدوات المساعدة، وأهمها `supabase.ts` و `supabase-admin.ts` لتهيئة الاتصال بقاعدة البيانات.
*   **`src/types`:** يحتوي على تعريفات TypeScript لكل أنواع البيانات في المشروع، مما يضمن أن البيانات متناسقة ويمنع الأخطاء.
*   **`src/api`:** يحتوي على الواجهات البرمجية (API Endpoints) التي تتعامل مع الطلبات من الواجهة الأمامية (مثل إضافة صنف جديد أو جلب قائمة المستخدمين).

---

## 2. قاعدة البيانات: القوة المزدوجة (سحابي ومتزامن)

هذه هي أهم وأذكى نقطة تقنية في المشروع بأكمله، وهي التي تضمن استمرارية العمل حتى في أسوأ الظروف. لقد اخترنا **Supabase** كحل شامل لقاعدة البيانات.

### أ. قاعدة البيانات السحابية (Supabase Postgres)

*   **ما هي؟** هي قاعدة البيانات الأساسية للمشروع، مبنية على PostgreSQL ومستضافة على خوادم Supabase السحابية. هذا يضمن أن البيانات آمنة، سريعة، ويمكن الوصول إليها من أي مكان.
*   **كيف تعمل؟** عندما يقوم أي مستخدم (مدير، شيف) بإجراء تغيير (مثل الموافقة على طلب)، يتم إرسال هذا التحديث إلى قاعدة بيانات Supabase.

### ب. التزامن اللحظي (Real-time Subscriptions)

*   **المشكلة:** كيف يمكن تحديث شاشات جميع الموظفين في نفس اللحظة عند تغيير حالة طلب؟
*   **الحل الذكي:** لقد قمنا بتفعيل ميزة **"الاشتراكات اللحظية" (Real-time Subscriptions)** في Supabase.
*   **كيف تعمل؟**
    1.  **الاستماع للتغييرات:** عند تشغيل التطبيق، يقوم بالاشتراك في "قناة" خاصة بجدول الطلبات في قاعدة البيانات.
    2.  **بث التحديثات:** عندما يحدث أي تغيير في جدول الطلبات (إضافة، تعديل، حذف)، تقوم Supabase فوراً بإرسال إشعار (Payload) يحتوي على البيانات الجديدة إلى كل المستخدمين المشتركين في القناة.
    3.  **التحديث الفوري للواجهة:** يستقبل التطبيق هذا الإشعار ويقوم بتحديث حالة الطلبات والطاولات في الواجهة الأمامية فوراً، دون الحاجة لإعادة تحميل الصفحة.

**الخلاصة:** هذه الميزة تمنح نظام "المائدة" قوة استثنائية وتفاعلية، حيث يشعر المستخدم أن التغييرات تحدث أمامه في الزمن الحقيقي، مما يجعله حلاً يمكن الاعتماد عليه في بيئة العمل الحقيقية للمطاعم.

---

## 3. مولد رموز QR الآمن والديناميكي

*   **كيف يعمل؟** عند طلب إنشاء رمز QR لطاولة، لا يتم استخدام عنوان IP ثابت. بدلاً من ذلك، يستخدم المولد أمراً برمجياً ذكياً (`window.location.origin`) يسأل المتصفح عن عنوانه الحالي.
*   **لماذا هذا مهم؟** هذا يعني أن الرموز التي يتم إنشاؤها ستعمل تلقائياً سواء كان التطبيق يعمل على جهازك المحلي (`localhost`)، أو على شبكة المطعم الداخلية (`192.168.x.x`)، أو على الإنترنت العام. لا حاجة لأي إعدادات يدوية للشبكة، مما يجعل النظام مرناً للغاية.
