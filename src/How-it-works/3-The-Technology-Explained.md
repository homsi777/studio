# 3. شرح التقنية: كيف يعمل النظام من الداخل؟

هذا المستند مخصص لأولئك الذين يرغبون في فهم أعمق لكيفية بناء نظام "المائدة"، مع التركيز على أهم القرارات التقنية التي تم اتخاذها، وخاصة فيما يتعلق بالبيانات والتزامن.

---

## 1. بنية المشروع (Project Structure)

تم تنظيم المشروع بطريقة معيارية لتسهيل الصيانة والتطوير المستقبلي.

*   **`src/app`:** هذا هو قلب تطبيق Next.js. كل مجلد بداخله يمثل "مساراً" أو صفحة في التطبيق (مثل `/chef`, `/settings`).
*   **`src/components`:** يحتوي على جميع مكونات React القابلة لإعادة الاستخدام. تم تقسيمها أيضاً إلى مجلدات فرعية حسب كل قسم (`/dashboard`, `/chef`...) لزيادة التنظيم.
*   **`src/hooks`:** يحتوي على "الخطافات" المخصصة، وهي التي تدير منطق الواجهة الأمامية.
    *   **`use-order-flow.tsx`:** هذا هو أهم خطاف في التطبيق، إنه العقل المدبر الذي يتتبع جميع الطلبات وحالاتها ويزامنها بين جميع الشاشات، ويدير عمليات التخزين المحلي والمزامنة.
    *   **`use-auth.tsx`:** يدير عملية تسجيل الدخول والخروج.
*   **`src/lib`:** يحتوي على الأدوات المساعدة، وأهمها `supabase.ts` (للاتصال من العميل) و `supabase-admin.ts` (للاتصال من الخادم) و `indexeddb.ts` (لإدارة قاعدة البيانات المحلية).
*   **`src/types`:** يحتوي على تعريفات TypeScript لكل أنواع البيانات في المشروع، مما يضمن أن البيانات متناسقة ويمنع الأخطاء.
*   **`src/api`:** يحتوي على الواجهات البرمجية (API Endpoints) التي تتعامل مع الطلبات من الواجهة الأمامية، خاصة لعمليات المزامنة.

---

## 2. قاعدة البيانات: القوة المزدوجة (سحابي ومحلي متزامن)

هذه هي أهم وأذكى نقطة تقنية في المشروع بأكمله، وهي التي تضمن استمرارية العمل حتى في أسوأ الظروف. لقد اخترنا بنية هجينة تجمع بين السحابة والتخزين المحلي.

### أ. قاعدة البيانات السحابية (Supabase Postgres)

*   **ما هي؟** هي قاعدة البيانات الأساسية والمصدر الوحيد للحقيقة للمشروع، مبنية على PostgreSQL ومستضافة على خوادم Supabase السحابية. هذا يضمن أن البيانات آمنة، سريعة، ويمكن الوصول إليها من أي مكان.
*   **كيف تعمل؟** عندما يقوم أي مستخدم (مدير، شيف) بإجراء تغيير (مثل الموافقة على طلب) أثناء اتصاله بالإنترنت، يتم إرسال هذا التحديث إلى قاعدة بيانات Supabase.

### ب. قاعدة البيانات المحلية (IndexedDB with Dexie.js)

*   **المشكلة:** ماذا يحدث إذا انقطع الإنترنت؟ هل يتوقف العمل؟
*   **الحل الذكي:** عند تشغيل التطبيق لأول مرة، يقوم بجلب نسخة من البيانات الأساسية (الطاولات، الطلبات، القائمة) من Supabase وتخزينها محلياً في متصفح المستخدم باستخدام **IndexedDB** (ومكتبة **Dexie.js** لتسهيل التعامل معها).
*   **كيف تعمل؟** إذا انقطع الاتصال، يتحول التطبيق بسلاسة للعمل على هذه النسخة المحلية. أي تغييرات يقوم بها المستخدم يتم حفظها في قاعدة البيانات المحلية.

### ج. آلية المزامنة (The Sync Engine)

*   **المشكلة:** كيف نضمن أن التغييرات التي حدثت في وضع عدم الاتصال تصل إلى الخادم عند عودة الاتصال؟
*   **الحل الذكي:**
    1.  **قائمة انتظار المزامنة:** أي تغيير يحدث في وضع عدم الاتصال (إضافة، تعديل، حذف) لا يتم إرساله مباشرة، بل يتم تسجيله كـ "عملية معلقة" في جدول خاص داخل IndexedDB اسمه `pendingSyncOperations`.
    2.  **المزامنة التلقائية:** عند عودة الاتصال بالإنترنت، يقوم مؤقت دوري في التطبيق بقراءة هذه القائمة وإرسال كل عملية معلقة بالترتيب إلى الواجهات الخلفية (API Routes) الخاصة بنا.
    3.  **تحديث آمن:** تقوم الواجهات الخلفية بتحديث قاعدة بيانات Supabase. عند نجاح العملية، يتم حذفها من قائمة الانتظار المحلية.

### د. التزامن اللحظي (Real-time Subscriptions)

*   **المشكلة:** كيف يمكن تحديث شاشات جميع الموظفين في نفس اللحظة عند تغيير حالة طلب؟
*   **الحل الذكي:** لقد قمنا بتفعيل ميزة **"الاشتراكات اللحظية" (Real-time Subscriptions)** في Supabase.
*   **كيف تعمل؟**
    1.  **الاستماع للتغييرات:** عند تشغيل التطبيق، يقوم بالاشتراك في "قناة" خاصة بجداول البيانات الهامة (مثل الطلبات والطاولات).
    2.  **بث التحديثات:** عندما يحدث أي تغيير في هذه الجداول في Supabase، تقوم Supabase فوراً بإرسال إشعار (Payload) يحتوي على البيانات الجديدة إلى كل المستخدمين المشتركين في القناة.
    3.  **التحديث الفوري للواجهة:** يستقبل التطبيق هذا الإشعار ويقوم بتحديث حالة الطلبات والطاولات في الواجهة الأمامية فوراً، دون الحاجة لإعادة تحميل الصفحة.

**الخلاصة:** هذه البنية المزدوجة تمنح نظام "المائدة" قوة استثنائية وموثوقية، فهو سريع بفضل التخزين المحلي، ودائماً محدث بفضل المزامنة اللحظية، ولا يتوقف عن العمل أبداً بفضل آلية المزامنة في الخلفية.

---

## 3. مولد رموز QR الآمن والديناميكي

*   **كيف يعمل؟** عند طلب إنشاء رمز QR لطاولة، لا يتم استخدام عنوان IP ثابت. بدلاً من ذلك، يستخدم المولد أمراً برمجياً ذكياً (`window.location.origin`) يسأل المتصفح عن عنوانه الحالي.
*   **لماذا هذا مهم؟** هذا يعني أن الرموز التي يتم إنشاؤها ستعمل تلقائياً سواء كان التطبيق يعمل على جهازك المحلي (`localhost`)، أو على شبكة المطعم الداخلية (`192.168.x.x`)، أو على الإنترنت العام. لا حاجة لأي إعدادات يدوية للشبكة، مما يجعل النظام مرناً للغاية.
