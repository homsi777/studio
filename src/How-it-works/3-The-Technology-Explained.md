# 3. شرح التقنية: كيف يعمل النظام من الداخل؟

هذا المستند مخصص لأولئك الذين يرغبون في فهم أعمق لكيفية بناء نظام "المائدة"، مع التركيز على أهم القرارات التقنية التي تم اتخاذها.

---

## 1. بنية المشروع (Project Structure)

تم تنظيم المشروع بطريقة معيارية لتسهيل الصيانة والتطوير المستقبلي.

*   **`src/app`:** هذا هو قلب تطبيق Next.js. كل مجلد بداخله يمثل "مساراً" أو صفحة في التطبيق (مثل `/chef`, `/settings`).
*   **`src/components`:** يحتوي على جميع مكونات React القابلة لإعادة الاستخدام. تم تقسيمها أيضاً إلى مجلدات فرعية حسب كل قسم (`/dashboard`, `/chef`...) لزيادة التنظيم.
*   **`src/hooks`:** يحتوي على "الخطافات" المخصصة، وهي التي تدير منطق الواجهة الأمامية.
    *   **`use-order-flow.tsx`:** هذا هو أهم خطاف في التطبيق، إنه العقل المدبر الذي يتتبع جميع الطلبات وحالاتها ويزامنها بين جميع الشاشات.
    *   **`use-auth.tsx`:** يدير عملية تسجيل الدخول والخروج.
*   **`src/lib`:** يحتوي على الأدوات المساعدة، وأهمها `firebase.ts` الذي يقوم بتهيئة قاعدة البيانات.
*   **`src/types`:** يحتوي على تعريفات TypeScript لكل أنواع البيانات في المشروع، مما يضمن أن البيانات متناسقة ويمنع الأخطاء.
*   **`src/api`:** يحتوي على الواجهات البرمجية (API Endpoints) التي تتعامل مع الطلبات من الواجهة الأمامية (مثل إضافة صنف جديد أو جلب قائمة المستخدمين).

---

## 2. قاعدة البيانات: السحر المزدوج (سحابي ومحلي)

هذه هي أهم وأذكى نقطة تقنية في المشروع بأكمله، وهي التي تضمن استمرارية العمل حتى في أسوأ الظروف.

### أ. قاعدة البيانات السحابية (Cloud Firestore)

*   **ما هي؟** هي قاعدة البيانات الأساسية للمشروع، موجودة على خوادم Google السحابية. هذا يضمن أن البيانات آمنة، سريعة، ويمكن الوصول إليها من أي مكان.
*   **كيف تعمل؟** عندما يقوم أي مستخدم (مدير، شيف) بإجراء تغيير (مثل الموافقة على طلب)، يتم إرسال هذا التحديث إلى قاعدة البيانات السحابية. قاعدة البيانات بدورها تقوم بإعلام جميع المستخدمين الآخرين المتصلين بالتحديث بشكل فوري (Real-time). هذا هو السبب في أن التغييرات تظهر على جميع الشاشات في نفس اللحظة.

### ب. قاعدة البيانات المحلية (Offline Persistence)

*   **المشكلة:** ماذا لو انقطع الإنترنت في المطعم؟ في الأنظمة التقليدية، هذا يعني توقف العمل بالكامل.
*   **الحل الذكي:** لقد قمنا بتفعيل ميزة في Firestore تسمى **"الصمود في وضع عدم الاتصال" (Offline Persistence)**.
*   **كيف تعمل؟**
    1.  **التخزين المؤقت:** عند تشغيل التطبيق لأول مرة (بوجود إنترنت)، تقوم Firestore تلقائياً بإنشاء نسخة طبق الأصل من قاعدة البيانات وتخزينها محلياً على جهاز الخادم في المطعم (داخل ذاكرة المتصفح المؤقتة).
    2.  **عند انقطاع الإنترنت:** بدلاً من أن يتوقف التطبيق عن العمل، يتحول تلقائياً للقراءة والكتابة من هذه النسخة المحلية. يمكن للشيف استقبال طلبات جديدة، ويمكن للمدير الموافقة عليها، وكل شيء يتم تسجيله في هذه القاعدة المحلية. **المستخدم النهائي (الشيف، المدير) لن يشعر بأي فرق إطلاقاً ولن تظهر له أي رسائل خطأ.**
    3.  **عند عودة الإنترنت:** تقوم Firestore بذكاء بمقارنة القاعدة المحلية بالقاعدة السحابية، وتقوم بمزامنة جميع التغييرات التي حدثت أثناء الانقطاع تلقائياً. كل الطلبات التي تم تسجيلها محلياً يتم رفعها إلى السحابة.

**الخلاصة:** هذه الميزة تمنح نظام "المائدة" قوة استثنائية وصموداً في وجه مشاكل الاتصال، مما يجعله حلاً يمكن الاعتماد عليه في بيئة العمل الحقيقية للمطاعم.

---

## 3. مولد رموز QR الآمن والديناميكي

*   **كيف يعمل؟** عند طلب إنشاء رمز QR لطاولة، لا يتم استخدام عنوان IP ثابت. بدلاً من ذلك، يستخدم المولد أمراً برمجياً ذكياً (`window.location.origin`) يسأل المتصفح عن عنوانه الحالي.
*   **لماذا هذا مهم؟** هذا يعني أن الرموز التي يتم إنشاؤها ستعمل تلقائياً سواء كان التطبيق يعمل على جهازك المحلي (`localhost`)، أو على شبكة المطعم الداخلية (`192.168.x.x`)، أو على الإنترنت العام. لا حاجة لأي إعدادات يدوية للشبكة، مما يجعل النظام مرناً للغاية.
