# العقد البرمجي (API Contract) لمشروع "المائدة" (الإصدار 2.0)

هذه الوثيقة هي المرجع الرسمي الذي يحدد كيفية تفاعل الواجهة الأمامية (Frontend) مع الواجهة الخلفية (Backend). إنها تحدد نماذج البيانات، ونقاط النهاية (API Endpoints) اللازمة لتشغيل التطبيق، مع التركيز على تدفق البيانات وعمليات CRUD.

---

## 1. نماذج البيانات (Data Models)

هذه هي الكيانات الرئيسية في النظام وكيفية تمثيلها كبيانات، مع مراعاة التناسق بين Supabase و IndexedDB.

### أ. الطاولة (Table)
**الغرض:** تخزين معلومات كل طاولة وربط رقمها بمعرف فريد وآمن (UUID).
| الحقل (Field) | النوع (Type) | الوصف | ملاحظات |
| :--- | :--- | :--- | :--- |
| `id` | `string` (UUID) | المعرف الفريد للطاولة (Primary Key) | يتم إنشاؤه تلقائياً في Supabase |
| `table_number` | `integer` | رقم الطاولة للعرض (مثال: 1, 2, 5) | مفهرس للبحث السريع |
| `status` | `string` | **حالة الطاولة:** `available`, `occupied`, `pending_order_approval` | يتم تحديثه بناءً على حالة الطلبات |
| `current_order_id`| `string` (UUID) | معرف الطلب الحالي المرتبط بالطاولة (Foreign Key to `orders.id`) | يمكن أن يكون `null` |
| `created_at` | `string` (ISO) | وقت إنشاء السجل | `TIMESTAMPTZ` في Supabase |
| `updated_at` | `string` (ISO) | وقت آخر تحديث | `TIMESTAMPTZ` في Supabase |

---
### ب. الصنف (MenuItem)
**الغرض:** تخزين تفاصيل كل صنف في القائمة.
| الحقل (Field) | النوع (Type) | الوصف | ملاحظات |
| :--- | :--- | :--- | :--- |
| `id` | `string` (UUID) | المعرف الفريد للصنف (Primary Key) | |
| `name` | `string` | اسم الصنف (عربي) | |
| `name_en` | `string` | اسم الصنف (إنجليزي) | |
| `description` | `text` | وصف الصنف (عربي) | |
| `description_en` | `text` | وصف الصنف (إنجليزي) | |
| `price` | `decimal` | سعر الصنف | `NUMERIC` في Supabase |
| `category` | `string` | تصنيف الصنف (main, appetizer, drink, dessert) | مفهرس للتصفية |
| `is_available` | `boolean` | هل الصنف متاح حالياً؟ | |
| `image_url` | `string` | رابط صورة الصنف (اختياري) | |
| `created_at` | `string` (ISO) | وقت الإنشاء | |
| `updated_at` | `string` (ISO) | وقت آخر تحديث | |

---
### ج. الطلب (Order)
**الغرض:** تسجيل كل طلب وتتبع حالته المعقدة عبر النظام.
| الحقل (Field) | النوع (Type) | الوصف | ملاحظات |
| :--- | :--- | :--- | :--- |
| `id` | `string` (UUID) | المعرف الفريد للطلب (Primary Key) | |
| `table_id` | `string` (UUID) | معرف الطاولة المرتبط بها الطلب (Foreign Key) | |
| `status` | `string` | **الحالة الحالية للطلب:** `pending_approval`, `in_progress`, `ready`, `served`, `completed`, `cancelled` | مفهرس للتصفية |
| `total_amount` | `decimal` | المبلغ الإجمالي للطلب | `NUMERIC` في Supabase |
| `is_paid` | `boolean` | هل تم دفع الفاتورة؟ | |
| `customer_notes` | `text` | ملاحظات الزبون على الطلب (اختياري) | |
| `created_at` | `string` (ISO) | وقت إنشاء الطلب من قبل الزبون | |
| `updated_at` | `string` (ISO) | وقت آخر تحديث | |
| `order_items` | `OrderItem[]` | تفاصيل الأصناف (علاقة) | في Supabase يتم جلبها عبر `JOIN`، في `IndexedDB` يتم تخزينها في جدول منفصل. |

---
### د. تفاصيل الطلب (OrderItem)
**الغرض:** ربط الطلبات بالأصناف والكميات.
| الحقل (Field) | النوع (Type) | الوصف | ملاحظات |
| :--- | :--- | :--- | :--- |
| `id` | `string` (UUID) | المعرف الفريد (Primary Key) | |
| `order_id` | `string` (UUID) | معرف الطلب (Foreign Key to `orders.id`) | |
| `menu_item_id` | `string` (UUID) | معرف الصنف (Foreign Key to `menu_items.id`) | |
| `quantity` | `integer` | كمية الصنف المطلوب | |
| `price` | `decimal` | سعر الصنف وقت الطلب (لضمان الثبات) | |
| `subtotal`| `decimal` | الإجمالي (quantity * price) | |
| `notes` | `text` | ملاحظات خاصة بالصنف (اختياري) | |
| `created_at` | `string` (ISO) | وقت الإنشاء | |
| `updated_at` | `string` (ISO) | وقت آخر تحديث | |

---

## 2. نقاط النهاية وتدفق البيانات (API Endpoints & Data Flow)

هذه الـ API Routes هي الجسر بين الواجهة الأمامية و Supabase، وهي ضرورية لعملية المزامنة.

### أ. إدارة الأصناف (`/api/v1/menu-items`)
*   **`GET /` (READ):** جلب جميع أصناف القائمة.
*   **`POST /` (CREATE):** إضافة صنف جديد (تستقبلها دالة المزامنة).
*   **`PUT /:id` (UPDATE):** تحديث بيانات صنف معين.
*   **`DELETE /:id` (DELETE):** حذف صنف معين.

### ب. إدارة الطلبات (`/api/v1/orders`)
*   **`GET /` (READ):** جلب جميع الطلبات (مع إمكانية الفلترة حسب الحالة).
*   **`POST /` (CREATE):** إنشاء طلب جديد.
*   **`PUT /:id` (UPDATE):** تحديث طلب موجود (لتغيير حالته أو إضافة أصناف).
*   **`DELETE /:id` (DELETE):** حذف طلب (يجب استخدامه بحذر).

### ج. إدارة الطاولات (`/api/v1/tables`)
*   **`GET /` (READ):** جلب جميع الطاولات.
*   **`POST /` (CREATE):** إضافة طاولة جديدة.
*   **`PUT /:id` (UPDATE):** تحديث حالة الطاولة.
*   **`DELETE /:id` (DELETE):** حذف طاولة.

---
### **منطق المزامنة عبر الـ API:**
عندما تقوم الواجهة الأمامية (عبر `useOrderFlow`) بإرسال عملية مزامنة إلى أحد هذه المسارات:
1.  **التحقق من الصلاحيات:** يجب أن تتحقق الـ API Route من أن المستخدم لديه الصلاحيات الكافية (مثلاً، مدير فقط يمكنه إضافة صنف).
2.  **التحقق من صحة البيانات (Validation):** يجب التحقق من أن البيانات المرسلة (payload) تتطابق مع المخطط الموحد.
3.  **تحديث `updated_at`:** عند أي عملية `PUT`، يجب على الـ API Route تحديث حقل `updated_at` إلى الوقت الحالي قبل إرسال التغيير إلى Supabase.
4.  **إعادة استجابة واضحة:** يجب أن تعيد الـ API Route استجابة `JSON` واضحة تحتوي على البيانات المحدثة أو رسالة خطأ صريحة.

---
هذا العقد هو **المرجع الوحيد والحاسم** الذي سنبني عليه الواجهة الخلفية ونربطها بالواجهة الأمامية. أي تعديلات مستقبلية يجب أن تُناقش وتُوثّق هنا أولاً.
