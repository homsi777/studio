# العقد البرمجي (API Contract) لمشروع "المائدة" (الإصدار 2.0)

هذه الوثيقة هي المرجع الرسمي الذي يحدد كيفية تفاعل الواجهة الأمامية (Frontend) مع الواجهة الخلفية (Backend). إنها تحدد نماذج البيانات، ونقاط النهاية (API Endpoints) اللازمة لتشغيل التطبيق، مع التركيز على تدفق البيانات وعمليات CRUD.

---

## 1. نماذج البيانات (Data Models)

هذه هي الكيانات الرئيسية في النظام وكيفية تمثيلها كبيانات.

### أ. الطاولة (Table)
**الغرض:** تخزين معلومات كل طاولة وربط رقمها بمعرف فريد وآمن (UUID).
| الحقل (Field)     | النوع (Type) | الوصف                                        |
| ------------------ | ------------- | -------------------------------------------- |
| `id`               | `integer`     | رقم الطاولة للعرض (مثال: 1, 2, 5)            |
| `uuid`             | `string`      | معرف فريد عالمي (UUID) للطاولة لروابط QR Code |
| `is_active`        | `boolean`     | هل الطاولة حالياً في الخدمة؟                 |

---
### ب. الصنف (MenuItem)
**الغرض:** تخزين تفاصيل كل صنف في القائمة.
| الحقل (Field)     | النوع (Type) | الوصف                                        |
| ------------------ | ------------- | -------------------------------------------- |
| `id`               | `string`      | معرف فريد (UUID)                            |
| `name`             | `string`      | اسم الصنف (عربي)                            |
| `name_en`          | `string`      | اسم الصنف (إنجليزي)                         |
| `description`      | `text`        | وصف الصنف (عربي)                           |
| `description_en`   | `text`        | وصف الصنف (إنجليزي)                         |
| `price`            | `decimal`     | سعر الصنف                                   |
| `category`         | `string`      | تصنيف الصنف (main, appetizer, drink, dessert) |
| `is_available`     | `boolean`     | هل الصنف متاح حالياً؟                      |

---
### ج. الطلب (Order)
**الغرض:** تسجيل كل طلب وتتبع حالته المعقدة عبر النظام.
| الحقل (Field)              | النوع (Type)             | الوصف                                                                                              |
| --------------------------- | ------------------------- | ------------------------------------------------------------------------------------------------- |
| `id`                        | `string`                  | معرف فريد (UUID)                                                                                |
| `table_uuid`                | `string`                  | معرف الطاولة الفريد المرتبط بها الطلب (Foreign Key)                                                |
| `status`                    | `string`                  | **الحالة الحالية للطلب (محور النظام):** `pending_chef_approval`, `pending_cashier_approval`, `pending_final_confirmation`, `confirmed`, `ready`, `completed`, `cancelled` |
| `total`                     | `decimal`                 | المبلغ الإجمالي للطلب                                                                           |
| `created_at`                | `timestamp`               | وقت إنشاء الطلب من قبل الزبون                                                                    |
| `chef_approved_at`          | `timestamp`               | وقت موافقة الشيف                                                                                |
| `cashier_approved_at`       | `timestamp`               | وقت موافقة المحاسب                                                                              |
| `customer_confirmed_at`     | `timestamp`               | وقت تأكيد الزبون النهائي                                                                       |
| `completed_at`              | `timestamp`               | وقت إتمام الطلب                                                                                 |
| `session_id`                | `string`                  | معرف الجلسة الفريد للزبون على المتصفح (Foreign Key to Sessions)                                       |


---
### د. تفاصيل الطلب (OrderItem)
**الغرض:** ربط الطلبات بالأصناف والكميات.
| الحقل (Field) | النوع (Type) | الوصف                    |
| -------------- | ------------- | ----------------------- |
| `order_id`     | `string`      | معرف الطلب (Foreign Key) |
| `menu_item_id` | `string`      | معرف الصنف (Foreign Key) |
| `quantity`     | `integer`     | كمية الصنف المطلوب     |
| `price_at_time`| `decimal`     | سعر الصنف وقت الطلب    |

---
### هـ. المصروف (Expense)
**الغرض:** تسجيل نفقات المطعم التشغيلية.
| الحقل (Field)   | النوع (Type)   | الوصف                                                               |
| ---------------- | -------------- | -------------------------------------------------------------------- |
| `id`             | `string`       | معرف فريد (UUID)                                                    |
| `description`    | `string`       | وصف المصروف                                                        |
| `amount`         | `decimal`      | مبلغ المصروف                                                        |
| `date`           | `date`         | تاريخ المصروف                                                       |
| `category`       | `string`       | تصنيف المصروف (rent, salaries, supplies...)                          |
| `user_id`        | `string`       | معرف الموظف الذي سجل المصروف (Foreign Key)                           |
| `invoice_image_url`| `string`     | رابط صورة الفاتورة (اختياري)                                        |

---
### و. المستخدم (User)
**الغرض:** تخزين معلومات حسابات الموظفين والمدراء.
| الحقل (Field) | النوع (Type) | الوصف                                        |
| -------------- | ------------- | ------------------------------------------- |
| `id`           | `string`      | معرف فريد (UUID)                           |
| `username`     | `string`      | اسم المستخدم للدخول (فريد)                  |
| `password`     | `string`      | كلمة المرور (مشفرة)                          |
| `role`         | `string`      | دور المستخدم (`manager` or `employee`)      |

---
### ز. جلسة الزبون (CustomerSession)
**الغرض:** تتبع كل جلسة تصفح فريدة للزبائن.
| الحقل (Field) | النوع (Type) | الوصف                                        |
| -------------- | ------------- | ------------------------------------------- |
| `id`           | `string`      | معرف الجلسة الفريد (UUID) - Primary Key     |
| `table_uuid`   | `string`      | معرف الطاولة المرتبط بالجلسة                 |
| `created_at`   | `timestamp`   | وقت بدء الجلسة                             |

---

## 2. نقاط النهاية وتدفق البيانات (API Endpoints & Data Flow)

### أ. إدارة قائمة الطعام (`/api/v1/menu-items`)
*   **`GET /` (READ):** جلب جميع أصناف القائمة لعرضها في `/menu-management` و `/menu/[uuid]`.
*   **`POST /` (CREATE):** إضافة صنف جديد إلى القائمة من النموذج في `/menu-management`.
*   **`PUT /:id` (UPDATE):** تحديث بيانات صنف معين.
*   **`DELETE /:id` (DELETE):** حذف صنف معين من القائمة.

### ب. قائمة الزبون (`/api/v1/customer/menu/:uuid`)
*   **`GET /:uuid` (READ):** الواجهة الأمامية ترسل `uuid` الطاولة، الواجهة الخلفية تعيد بيانات القائمة الكاملة ورقم الطاولة للعرض.

### ج. تدفق الطلبات (محور النظام) (`/api/v1/orders`)
*   **`POST /` (CREATE):**
    *   **الوصف:** الزبون يرسل طلبه الأولي.
    *   **البيانات المرسلة:** `{ table_uuid, items: [{ menu_item_id, quantity }], session_id }`
    *   **الإجراء:** الواجهة الخلفية تنشئ طلباً جديداً بحالة `pending_chef_approval`.
    *   **الإشعار:** يتم إرسال إشعار لحظي (WebSocket/SSE) إلى واجهة الشيف.

*   **`GET /` (READ):**
    *   **الوصف:** جلب الطلبات لواجهة الشيف أو المدير.
    *   **الاستخدام:** `/chef` تستخدمه لجلب الطلبات بـ `?status=pending_chef_approval` و `?status=confirmed`.

*   **`PUT /:id/approve-chef` (UPDATE):**
    *   **الوصف:** الشيف يوافق على الطلب.
    *   **الإجراء:** الواجهة الخلفية تحدث حالة الطلب إلى `pending_cashier_approval`.
    *   **الإشعار:** يتم إرسال إشعار لحظي إلى واجهة المدير/المحاسب (لتغيير لون الطاولة) وإلى الزبون.

*   **`PUT /:id/approve-cashier` (UPDATE):**
    *   **الوصف:** المحاسب يوافق على الطلب.
    *   **الإجراء:** الواجهة الخلفية تحدث حالة الطلب إلى `pending_final_confirmation`.
    *   **الإشعار:** يتم إرسال إشعار لحظي إلى الزبون (لعرض زر التأكيد النهائي).

*   **`PUT /:id/confirm-customer` (UPDATE):**
    *   **الوصف:** الزبون يؤكد الطلب نهائياً.
    *   **الإجراء:** الواجهة الخلفية تحدث حالة الطلب إلى `confirmed`.
    *   **الإشعار:** يتم إرسال إشعار لحظي إلى الشيف (لنقل الطلب إلى عمود "قيد التحضير").

*   **`PUT /:id/ready` (UPDATE):**
    *   **الوصف:** الشيف يعلن أن الطلب جاهز.
    *   **الإجراء:** الواجهة الخلفية تحدث حالة الطلب إلى `ready`.
    *   **الإشعار:** يتم إرسال إشعار لحظي إلى المدير/الكاشير.

### د. إدارة المصاريف (`/api/v1/expenses`)
*   **`GET /` (READ):** جلب جميع المصاريف مع دعم الفلاتر `?startDate=...&endDate=...&category=...`.
*   **`POST /` (CREATE):** تسجيل مصروف جديد. يمكن أن يتضمن رفع صورة (`multipart/form-data`).
*   **`PUT /:id` (UPDATE):** تحديث بيانات مصروف معين.
*   **`DELETE /:id` (DELETE):** حذف مصروف معين.

### هـ. إدارة المستخدمين (`/api/v1/users`)
*   **`GET /` (READ):** جلب قائمة جميع المستخدمين لعرضها في `/settings`.
*   **`POST /` (CREATE):** إضافة مستخدم جديد (مدير أو موظف).
*   **`PUT /:id` (UPDATE):** تحديث بيانات مستخدم (اسم المستخدم، الدور، كلمة المرور).
*   **`DELETE /:id` (DELETE):** حذف مستخدم.

---
هذا العقد هو **المرجع الوحيد والحاسم** الذي سنبني عليه الواجهة الخلفية ونربطها بالواجهة الأمامية. أي تعديلات مستقبلية يجب أن تُناقش وتُوثّق هنا أولاً.
